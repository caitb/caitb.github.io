<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="åº”ç”¨ 4ï¼šå››ä¸¤æ‹¨åƒæ–¤ â€”â€” HyperLogLog"><meta name="keywords" content="è½¬å‘,Redis"><meta name="author" content="CAI TB,undefined"><meta name="copyright" content="CAI TB"><title>åº”ç”¨ 4ï¼šå››ä¸¤æ‹¨åƒæ–¤ â€”â€” HyperLogLog | CAITBã®Blog</title><link rel="shortcut icon" href="/my-favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.5.6"><link rel="stylesheet" href="/css/vue.css?version=1.5.6"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css?version=1.5.6"><link rel="dns-prefetch" href="https://cdn.staticfile.org"><link rel="dns-prefetch" href="https://cdn.bootcss.com"><link rel="dns-prefetch" href="https://creativecommons.org"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"æ‰¾ä¸åˆ°æ‚¨æŸ¥è¯¢çš„å†…å®¹:${query}"}},
  copy: {
    success: 'å¤åˆ¶æˆåŠŸ',
    error: 'å¤åˆ¶é”™è¯¯',
    noSupport: 'æµè§ˆå™¨ä¸æ”¯æŒ'
  }
} </script></head><body><canvas class="fireworks"></canvas><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div class="sidebar" id="sidebar"><div class="toggle-sidebar-info text-center"><span data-toggle="åˆ‡æ¢æ–‡ç« è¯¦æƒ…">åˆ‡æ¢ç«™ç‚¹æ¦‚è§ˆ</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">ç›®å½•</div><div class="sidebar-toc__progress"><span class="progress-notice">ä½ å·²ç»è¯»äº†</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-nav sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#ä½¿ç”¨æ–¹æ³•"><span class="toc-number">1.</span> <span class="toc-text">ä½¿ç”¨æ–¹æ³•</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#pfadd-è¿™ä¸ª-pf-æ˜¯ä»€ä¹ˆæ„æ€ï¼Ÿ"><span class="toc-number">2.</span> <span class="toc-text">pfadd è¿™ä¸ª pf æ˜¯ä»€ä¹ˆæ„æ€ï¼Ÿ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#pfmerge-é€‚åˆä»€ä¹ˆåœºåˆç”¨ï¼Ÿ"><span class="toc-number">3.</span> <span class="toc-text">pfmerge é€‚åˆä»€ä¹ˆåœºåˆç”¨ï¼Ÿ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#æ³¨æ„äº‹é¡¹"><span class="toc-number">4.</span> <span class="toc-text">æ³¨æ„äº‹é¡¹</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#HyperLogLog-å®ç°åŸç†"><span class="toc-number"></span> <span class="toc-text">HyperLogLog å®ç°åŸç†</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#pf-çš„å†…å­˜å ç”¨ä¸ºä»€ä¹ˆæ˜¯-12kï¼Ÿ"><span class="toc-number">1.</span> <span class="toc-text">pf çš„å†…å­˜å ç”¨ä¸ºä»€ä¹ˆæ˜¯ 12kï¼Ÿ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#æ€è€ƒ-amp-ä½œä¸š"><span class="toc-number">2.</span> <span class="toc-text">æ€è€ƒ &amp; ä½œä¸š</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#æ‰©å±•é˜…è¯»"><span class="toc-number"></span> <span class="toc-text">æ‰©å±•é˜…è¯»</span></a></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="https://ws2.sinaimg.cn/large/006tNbRwgy1fvak7x33btj30500500ui.jpg"></div><div class="author-info__name text-center">CAI TB</div><div class="author-info__description text-center"></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">æ–‡ç« </span><span class="pull-right">27</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">æ ‡ç­¾</span><span class="pull-right">11</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">åˆ†ç±»</span><span class="pull-right">2</span></a></div></div></div><div class="content" id="content-outer"><div id="top-container" style="background-image: url(https://ws1.sinaimg.cn/large/006tNbRwgy1fvak4ulv7nj31hc0xc0yl.jpg)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">CAITBã®Blog</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus"><a class="site-page social-icon search"><i class="fa fa-search"></i><span> æœç´¢</span></a><a class="site-page" href="/">é¦–é¡µ</a><a class="site-page" href="/archives">å½’æ¡£</a><a class="site-page" href="/tags">æ ‡ç­¾</a><a class="site-page" href="/categories">åˆ†ç±»</a></span></div><div id="post-info"><div id="post-title">åº”ç”¨ 4ï¼šå››ä¸¤æ‹¨åƒæ–¤ â€”â€” HyperLogLog</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2018-09-25</time></div></div></div><div class="layout" id="content-inner"><article class="markdown-section" id="post"><div class="article-container" id="post-content"><blockquote>
<p><span style="color:rgb(61, 170, 214)">ä½œè€…ï¼š</span>æ˜é‡‘å°å†Œ</p>
<p><span style="color:rgb(61, 170, 214)">æ¥æºï¼š</span><a href="https://juejin.im/books" target="_blank" rel="noopener">https://juejin.im/books</a></p>
</blockquote>
<p>åœ¨å¼€å§‹è¿™ä¸€èŠ‚ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ€è€ƒä¸€ä¸ªå¸¸è§çš„ä¸šåŠ¡é—®é¢˜ï¼šå¦‚æœä½ è´Ÿè´£å¼€å‘ç»´æŠ¤ä¸€ä¸ªå¤§å‹çš„ç½‘ç«™ï¼Œæœ‰ä¸€å¤©è€æ¿æ‰¾äº§å“ç»ç†è¦ç½‘ç«™æ¯ä¸ªç½‘é¡µæ¯å¤©çš„ UV æ•°æ®ï¼Œç„¶åè®©ä½ æ¥å¼€å‘è¿™ä¸ªç»Ÿè®¡æ¨¡å—ï¼Œä½ ä¼šå¦‚ä½•å®ç°ï¼Ÿ</p>
<p><img src="https://user-gold-cdn.xitu.io/2018/7/12/1648f065e38200cb?imageslim" alt="img"></p>
<p>å¦‚æœç»Ÿè®¡ PV é‚£éå¸¸å¥½åŠï¼Œç»™æ¯ä¸ªç½‘é¡µä¸€ä¸ªç‹¬ç«‹çš„ Redis è®¡æ•°å™¨å°±å¯ä»¥äº†ï¼Œè¿™ä¸ªè®¡æ•°å™¨çš„ key åç¼€åŠ ä¸Šå½“å¤©çš„æ—¥æœŸã€‚è¿™æ ·æ¥ä¸€ä¸ªè¯·æ±‚ï¼Œincrby ä¸€æ¬¡ï¼Œæœ€ç»ˆå°±å¯ä»¥ç»Ÿè®¡å‡ºæ‰€æœ‰çš„ PV æ•°æ®ã€‚</p>
<p>ä½†æ˜¯ UV ä¸ä¸€æ ·ï¼Œå®ƒè¦å»é‡ï¼ŒåŒä¸€ä¸ªç”¨æˆ·ä¸€å¤©ä¹‹å†…çš„å¤šæ¬¡è®¿é—®è¯·æ±‚åªèƒ½è®¡æ•°ä¸€æ¬¡ã€‚è¿™å°±è¦æ±‚æ¯ä¸€ä¸ªç½‘é¡µè¯·æ±‚éƒ½éœ€è¦å¸¦ä¸Šç”¨æˆ·çš„ IDï¼Œæ— è®ºæ˜¯ç™»é™†ç”¨æˆ·è¿˜æ˜¯æœªç™»é™†ç”¨æˆ·éƒ½éœ€è¦ä¸€ä¸ªå”¯ä¸€ ID æ¥æ ‡è¯†ã€‚</p>
<p>ä½ ä¹Ÿè®¸å·²ç»æƒ³åˆ°äº†ä¸€ä¸ªç®€å•çš„æ–¹æ¡ˆï¼Œé‚£å°±æ˜¯ä¸ºæ¯ä¸€ä¸ªé¡µé¢ä¸€ä¸ªç‹¬ç«‹çš„ set é›†åˆæ¥å­˜å‚¨æ‰€æœ‰å½“å¤©è®¿é—®è¿‡æ­¤é¡µé¢çš„ç”¨æˆ· IDã€‚å½“ä¸€ä¸ªè¯·æ±‚è¿‡æ¥æ—¶ï¼Œæˆ‘ä»¬ä½¿ç”¨ sadd å°†ç”¨æˆ· ID å¡è¿›å»å°±å¯ä»¥äº†ã€‚é€šè¿‡ scard å¯ä»¥å–å‡ºè¿™ä¸ªé›†åˆçš„å¤§å°ï¼Œè¿™ä¸ªæ•°å­—å°±æ˜¯è¿™ä¸ªé¡µé¢çš„ UV æ•°æ®ã€‚æ²¡é”™ï¼Œè¿™æ˜¯ä¸€ä¸ªéå¸¸ç®€å•çš„æ–¹æ¡ˆã€‚</p>
<p>ä½†æ˜¯ï¼Œå¦‚æœä½ çš„é¡µé¢è®¿é—®é‡éå¸¸å¤§ï¼Œæ¯”å¦‚ä¸€ä¸ªçˆ†æ¬¾é¡µé¢å‡ åƒä¸‡çš„ UVï¼Œä½ éœ€è¦ä¸€ä¸ªå¾ˆå¤§çš„ set é›†åˆæ¥ç»Ÿè®¡ï¼Œè¿™å°±éå¸¸æµªè´¹ç©ºé—´ã€‚å¦‚æœè¿™æ ·çš„é¡µé¢å¾ˆå¤šï¼Œé‚£æ‰€éœ€è¦çš„å­˜å‚¨ç©ºé—´æ˜¯æƒŠäººçš„ã€‚ä¸ºè¿™æ ·ä¸€ä¸ªå»é‡åŠŸèƒ½å°±è€—è´¹è¿™æ ·å¤šçš„å­˜å‚¨ç©ºé—´ï¼Œå€¼å¾—ä¹ˆï¼Ÿå…¶å®è€æ¿éœ€è¦çš„æ•°æ®åˆä¸éœ€è¦å¤ªç²¾ç¡®ï¼Œ105w å’Œ 106w è¿™ä¸¤ä¸ªæ•°å­—å¯¹äºè€æ¿ä»¬æ¥è¯´å¹¶æ²¡æœ‰å¤šå¤§åŒºåˆ«ï¼ŒSoï¼Œæœ‰æ²¡æœ‰æ›´å¥½çš„è§£å†³æ–¹æ¡ˆå‘¢ï¼Ÿ</p>
<p>è¿™å°±æ˜¯æœ¬èŠ‚è¦å¼•å…¥çš„ä¸€ä¸ªè§£å†³æ–¹æ¡ˆï¼ŒRedis æä¾›äº† HyperLogLog æ•°æ®ç»“æ„å°±æ˜¯ç”¨æ¥è§£å†³è¿™ç§ç»Ÿè®¡é—®é¢˜çš„ã€‚HyperLogLog æä¾›ä¸ç²¾ç¡®çš„å»é‡è®¡æ•°æ–¹æ¡ˆï¼Œè™½ç„¶ä¸ç²¾ç¡®ä½†æ˜¯ä¹Ÿä¸æ˜¯éå¸¸ä¸ç²¾ç¡®ï¼Œæ ‡å‡†è¯¯å·®æ˜¯ 0.81%ï¼Œè¿™æ ·çš„ç²¾ç¡®åº¦å·²ç»å¯ä»¥æ»¡è¶³ä¸Šé¢çš„ UV ç»Ÿè®¡éœ€æ±‚äº†ã€‚</p>
<p>HyperLogLog æ•°æ®ç»“æ„æ˜¯ Redis çš„é«˜çº§æ•°æ®ç»“æ„ï¼Œå®ƒéå¸¸æœ‰ç”¨ï¼Œä½†æ˜¯ä»¤äººæ„Ÿåˆ°æ„å¤–çš„æ˜¯ï¼Œä½¿ç”¨è¿‡å®ƒçš„äººéå¸¸å°‘ã€‚</p>
<p>&nbsp;</p>
<h3 id="ä½¿ç”¨æ–¹æ³•"><a href="#ä½¿ç”¨æ–¹æ³•" class="headerlink" title="ä½¿ç”¨æ–¹æ³•"></a>ä½¿ç”¨æ–¹æ³•</h3><p>HyperLogLog æä¾›äº†ä¸¤ä¸ªæŒ‡ä»¤ pfadd å’Œ pfcountï¼Œæ ¹æ®å­—é¢æ„ä¹‰å¾ˆå¥½ç†è§£ï¼Œä¸€ä¸ªæ˜¯å¢åŠ è®¡æ•°ï¼Œä¸€ä¸ªæ˜¯è·å–è®¡æ•°ã€‚pfadd ç”¨æ³•å’Œ set é›†åˆçš„ sadd æ˜¯ä¸€æ ·çš„ï¼Œæ¥ä¸€ä¸ªç”¨æˆ· IDï¼Œå°±å°†ç”¨æˆ· ID å¡è¿›å»å°±æ˜¯ã€‚pfcount å’Œ scard ç”¨æ³•æ˜¯ä¸€æ ·çš„ï¼Œç›´æ¥è·å–è®¡æ•°å€¼ã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; pfadd codehole user1</span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; pfcount codehole</span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; pfadd codehole user2</span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; pfcount codehole</span><br><span class="line">(<span class="built_in">integer</span>) 2</span><br><span class="line">127.0.0.1:6379&gt; pfadd codehole user3</span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; pfcount codehole</span><br><span class="line">(<span class="built_in">integer</span>) 3</span><br><span class="line">127.0.0.1:6379&gt; pfadd codehole user4</span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; pfcount codehole</span><br><span class="line">(<span class="built_in">integer</span>) 4</span><br><span class="line">127.0.0.1:6379&gt; pfadd codehole user5</span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; pfcount codehole</span><br><span class="line">(<span class="built_in">integer</span>) 5</span><br><span class="line">127.0.0.1:6379&gt; pfadd codehole user6</span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; pfcount codehole</span><br><span class="line">(<span class="built_in">integer</span>) 6</span><br><span class="line">127.0.0.1:6379&gt; pfadd codehole user7 user8 user9 user10</span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; pfcount codehole</span><br><span class="line">(<span class="built_in">integer</span>) 10</span><br></pre></td></tr></table></figure>
<p>ç®€å•è¯•äº†ä¸€ä¸‹ï¼Œå‘ç°è¿˜è›®ç²¾ç¡®çš„ï¼Œä¸€ä¸ªæ²¡å¤šä¹Ÿä¸€ä¸ªæ²¡å°‘ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬ä½¿ç”¨è„šæœ¬ï¼Œå¾€é‡Œé¢çŒæ›´å¤šçš„æ•°æ®ï¼Œçœ‹çœ‹å®ƒæ˜¯å¦è¿˜å¯ä»¥ç»§ç»­ç²¾ç¡®ä¸‹å»ï¼Œå¦‚æœä¸èƒ½ç²¾ç¡®ï¼Œå·®è·æœ‰å¤šå¤§ã€‚äººç”Ÿè‹¦çŸ­ï¼Œæˆ‘ç”¨ Pythonï¼Python è„šæœ¬èµ°èµ·æ¥ï¼ğŸ˜„</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># coding: utf-8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> redis</span><br><span class="line"></span><br><span class="line">client = redis.StrictRedis()</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1000</span>):</span><br><span class="line">    client.pfadd(<span class="string">"codehole"</span>, <span class="string">"user%d"</span> % i)</span><br><span class="line">    total = client.pfcount(<span class="string">"codehole"</span>)</span><br><span class="line">    <span class="keyword">if</span> total != i+<span class="number">1</span>:</span><br><span class="line">        <span class="keyword">print</span> total, i+<span class="number">1</span></span><br><span class="line">        <span class="keyword">break</span></span><br></pre></td></tr></table></figure>
<p>å½“ç„¶ Java ä¹Ÿä¸é”™ï¼Œå¤§åŒå°å¼‚ï¼Œä¸‹é¢æ˜¯ Java ç‰ˆæœ¬ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PfTest</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    Jedis jedis = <span class="keyword">new</span> Jedis();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">1000</span>; i++) &#123;</span><br><span class="line">      jedis.pfadd(<span class="string">"codehole"</span>, <span class="string">"user"</span> + i);</span><br><span class="line">      <span class="keyword">long</span> total = jedis.pfcount(<span class="string">"codehole"</span>);</span><br><span class="line">      <span class="keyword">if</span> (total != i + <span class="number">1</span>) &#123;</span><br><span class="line">        System.out.printf(<span class="string">"%d %d\n"</span>, total, i + <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    jedis.close();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬æ¥çœ‹ä¸‹è¾“å‡ºï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; python pftest.py</span><br><span class="line">99 100</span><br></pre></td></tr></table></figure>
<p>å½“æˆ‘ä»¬åŠ å…¥ç¬¬ 100 ä¸ªå…ƒç´ æ—¶ï¼Œç»“æœå¼€å§‹å‡ºç°äº†ä¸ä¸€è‡´ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬å°†æ•°æ®å¢åŠ åˆ° 10w ä¸ªï¼Œçœ‹çœ‹æ€»é‡å·®è·æœ‰å¤šå¤§ã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># coding: utf-8</span></span><br><span class="line"></span><br><span class="line">import redis</span><br><span class="line"></span><br><span class="line">client = redis.StrictRedis()</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(100000):</span><br><span class="line">    client.pfadd(<span class="string">"codehole"</span>, <span class="string">"user%d"</span> % i)</span><br><span class="line"><span class="built_in">print</span> 100000, client.pfcount(<span class="string">"codehole"</span>)</span><br></pre></td></tr></table></figure>
<p>Java ç‰ˆï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JedisTest</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    Jedis jedis = <span class="keyword">new</span> Jedis();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">100000</span>; i++) &#123;</span><br><span class="line">      jedis.pfadd(<span class="string">"codehole"</span>, <span class="string">"user"</span> + i);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">long</span> total = jedis.pfcount(<span class="string">"codehole"</span>);</span><br><span class="line">    System.out.printf(<span class="string">"%d %d\n"</span>, <span class="number">100000</span>, total);</span><br><span class="line">    jedis.close();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è·‘äº†çº¦åŠåˆ†é’Ÿï¼Œæˆ‘ä»¬çœ‹è¾“å‡ºï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; python pftest.py</span><br><span class="line">100000 99723</span><br></pre></td></tr></table></figure>
<p>å·®äº† 277 ä¸ªï¼ŒæŒ‰ç™¾åˆ†æ¯”æ˜¯ 0.277%ï¼Œå¯¹äºä¸Šé¢çš„ UV ç»Ÿè®¡éœ€æ±‚æ¥è¯´ï¼Œè¯¯å·®ç‡ä¹Ÿä¸ç®—é«˜ã€‚ç„¶åæˆ‘ä»¬æŠŠä¸Šé¢çš„è„šæœ¬å†è·‘ä¸€è¾¹ï¼Œä¹Ÿå°±ç›¸å½“äºå°†æ•°æ®é‡å¤åŠ å…¥ä¸€è¾¹ï¼ŒæŸ¥çœ‹è¾“å‡ºï¼Œå¯ä»¥å‘ç°ï¼Œpfcount çš„ç»“æœæ²¡æœ‰ä»»ä½•æ”¹å˜ï¼Œè¿˜æ˜¯ 99723ï¼Œè¯´æ˜å®ƒç¡®å®å…·å¤‡å»é‡åŠŸèƒ½ã€‚</p>
<p>&nbsp;</p>
<h3 id="pfadd-è¿™ä¸ª-pf-æ˜¯ä»€ä¹ˆæ„æ€ï¼Ÿ"><a href="#pfadd-è¿™ä¸ª-pf-æ˜¯ä»€ä¹ˆæ„æ€ï¼Ÿ" class="headerlink" title="pfadd è¿™ä¸ª pf æ˜¯ä»€ä¹ˆæ„æ€ï¼Ÿ"></a>pfadd è¿™ä¸ª pf æ˜¯ä»€ä¹ˆæ„æ€ï¼Ÿ</h3><p>å®ƒæ˜¯ HyperLogLog è¿™ä¸ªæ•°æ®ç»“æ„çš„å‘æ˜äºº Philippe Flajolet çš„é¦–å­—æ¯ç¼©å†™ï¼Œè€å¸ˆè§‰å¾—ä»–å‘å‹å¾ˆé…·ï¼Œçœ‹èµ·æ¥æ˜¯ä¸ªä½›ç³»æ•™æˆã€‚</p>
<p><img src="https://user-gold-cdn.xitu.io/2018/7/12/1648f09fa1a77152?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" alt="img"></p>
<p>&nbsp;</p>
<h3 id="pfmerge-é€‚åˆä»€ä¹ˆåœºåˆç”¨ï¼Ÿ"><a href="#pfmerge-é€‚åˆä»€ä¹ˆåœºåˆç”¨ï¼Ÿ" class="headerlink" title="pfmerge é€‚åˆä»€ä¹ˆåœºåˆç”¨ï¼Ÿ"></a>pfmerge é€‚åˆä»€ä¹ˆåœºåˆç”¨ï¼Ÿ</h3><p>HyperLogLog é™¤äº†ä¸Šé¢çš„ pfadd å’Œ pfcount ä¹‹å¤–ï¼Œè¿˜æä¾›äº†ç¬¬ä¸‰ä¸ªæŒ‡ä»¤ pfmergeï¼Œç”¨äºå°†å¤šä¸ª pf è®¡æ•°å€¼ç´¯åŠ åœ¨ä¸€èµ·å½¢æˆä¸€ä¸ªæ–°çš„ pf å€¼ã€‚</p>
<p>æ¯”å¦‚åœ¨ç½‘ç«™ä¸­æˆ‘ä»¬æœ‰ä¸¤ä¸ªå†…å®¹å·®ä¸å¤šçš„é¡µé¢ï¼Œè¿è¥è¯´éœ€è¦è¿™ä¸¤ä¸ªé¡µé¢çš„æ•°æ®è¿›è¡Œåˆå¹¶ã€‚å…¶ä¸­é¡µé¢çš„ UV è®¿é—®é‡ä¹Ÿéœ€è¦åˆå¹¶ï¼Œé‚£è¿™ä¸ªæ—¶å€™ pfmerge å°±å¯ä»¥æ´¾ä¸Šç”¨åœºäº†ã€‚</p>
<p>&nbsp;</p>
<h3 id="æ³¨æ„äº‹é¡¹"><a href="#æ³¨æ„äº‹é¡¹" class="headerlink" title="æ³¨æ„äº‹é¡¹"></a>æ³¨æ„äº‹é¡¹</h3><p>HyperLogLog è¿™ä¸ªæ•°æ®ç»“æ„ä¸æ˜¯å…è´¹çš„ï¼Œä¸æ˜¯è¯´ä½¿ç”¨è¿™ä¸ªæ•°æ®ç»“æ„è¦èŠ±é’±ï¼Œå®ƒéœ€è¦å æ®ä¸€å®š 12k çš„å­˜å‚¨ç©ºé—´ï¼Œæ‰€ä»¥å®ƒä¸é€‚åˆç»Ÿè®¡å•ä¸ªç”¨æˆ·ç›¸å…³çš„æ•°æ®ã€‚å¦‚æœä½ çš„ç”¨æˆ·ä¸Šäº¿ï¼Œå¯ä»¥ç®—ç®—ï¼Œè¿™ä¸ªç©ºé—´æˆæœ¬æ˜¯éå¸¸æƒŠäººçš„ã€‚ä½†æ˜¯ç›¸æ¯” set å­˜å‚¨æ–¹æ¡ˆï¼ŒHyperLogLog æ‰€ä½¿ç”¨çš„ç©ºé—´é‚£çœŸæ˜¯å¯ä»¥ä½¿ç”¨åƒæ–¤å¯¹æ¯”å››ä¸¤æ¥å½¢å®¹äº†ã€‚</p>
<p>ä¸è¿‡ä½ ä¹Ÿä¸å¿…è¿‡äºæ‹…å¿ƒï¼Œå› ä¸º Redis å¯¹ HyperLogLog çš„å­˜å‚¨è¿›è¡Œäº†ä¼˜åŒ–ï¼Œåœ¨è®¡æ•°æ¯”è¾ƒå°æ—¶ï¼Œå®ƒçš„å­˜å‚¨ç©ºé—´é‡‡ç”¨ç¨€ç–çŸ©é˜µå­˜å‚¨ï¼Œç©ºé—´å ç”¨å¾ˆå°ï¼Œä»…ä»…åœ¨è®¡æ•°æ…¢æ…¢å˜å¤§ï¼Œç¨€ç–çŸ©é˜µå ç”¨ç©ºé—´æ¸æ¸è¶…è¿‡äº†é˜ˆå€¼æ—¶æ‰ä¼šä¸€æ¬¡æ€§è½¬å˜æˆç¨ å¯†çŸ©é˜µï¼Œæ‰ä¼šå ç”¨ 12k çš„ç©ºé—´ã€‚</p>
<p>&nbsp;</p>
<h2 id="HyperLogLog-å®ç°åŸç†"><a href="#HyperLogLog-å®ç°åŸç†" class="headerlink" title="HyperLogLog å®ç°åŸç†"></a>HyperLogLog å®ç°åŸç†</h2><p>HyperLogLog çš„ä½¿ç”¨éå¸¸ç®€å•ï¼Œä½†æ˜¯å®ç°åŸç†æ¯”è¾ƒå¤æ‚ï¼Œå¦‚æœè¯»è€…æ²¡æœ‰ç‰¹åˆ«çš„å…´è¶£ï¼Œä¸‹é¢çš„å†…å®¹æš‚æ—¶å¯ä»¥è·³è¿‡ä¸çœ‹ã€‚</p>
<p>ä¸ºäº†æ–¹ä¾¿ç†è§£ HyperLogLog çš„å†…éƒ¨å®ç°åŸç†ï¼Œæˆ‘ç”»äº†ä¸‹é¢è¿™å¼ å›¾</p>
<p><img src="https://user-gold-cdn.xitu.io/2018/7/12/1648f0af2621881b?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" alt="img"></p>
<p>è¿™å¼ å›¾çš„æ„æ€æ˜¯ï¼Œç»™å®šä¸€ç³»åˆ—çš„éšæœºæ•´æ•°ï¼Œæˆ‘ä»¬è®°å½•ä¸‹ä½ä½è¿ç»­é›¶ä½çš„æœ€å¤§é•¿åº¦ kï¼Œé€šè¿‡è¿™ä¸ª k å€¼å¯ä»¥ä¼°ç®—å‡ºéšæœºæ•°çš„æ•°é‡ã€‚ é¦–å…ˆä¸é—®ä¸ºä»€ä¹ˆï¼Œæˆ‘ä»¬ç¼–å†™ä»£ç åšä¸€ä¸ªå®éªŒï¼Œè§‚å¯Ÿä¸€ä¸‹éšæœºæ•´æ•°çš„æ•°é‡å’Œ k å€¼çš„å…³ç³»ã€‚</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> math</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç®—ä½ä½é›¶çš„ä¸ªæ•°</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">low_zeros</span><span class="params">(value)</span>:</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> xrange(<span class="number">1</span>, <span class="number">32</span>):</span><br><span class="line">        <span class="keyword">if</span> value &gt;&gt; i &lt;&lt; i != value:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">return</span> i - <span class="number">1</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># é€šè¿‡éšæœºæ•°è®°å½•æœ€å¤§çš„ä½ä½é›¶çš„ä¸ªæ•°</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BitKeeper</span><span class="params">(object)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.maxbits = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">random</span><span class="params">(self)</span>:</span></span><br><span class="line">        value = random.randint(<span class="number">0</span>, <span class="number">2</span>**<span class="number">32</span><span class="number">-1</span>)</span><br><span class="line">        bits = low_zeros(value)</span><br><span class="line">        <span class="keyword">if</span> bits &gt; self.maxbits:</span><br><span class="line">            self.maxbits = bits</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Experiment</span><span class="params">(object)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, n)</span>:</span></span><br><span class="line">        self.n = n</span><br><span class="line">        self.keeper = BitKeeper()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">do</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(self.n):</span><br><span class="line">            self.keeper.random()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">debug</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">print</span> self.n, <span class="string">'%.2f'</span> % math.log(self.n, <span class="number">2</span>), self.keeper.maxbits</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1000</span>, <span class="number">100000</span>, <span class="number">100</span>):</span><br><span class="line">    exp = Experiment(i)</span><br><span class="line">    exp.do()</span><br><span class="line">    exp.debug()</span><br></pre></td></tr></table></figure>
<p>Java ç‰ˆï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PfTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">BitKeeper</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> maxbits;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">random</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">long</span> value = ThreadLocalRandom.current().nextLong(<span class="number">2L</span> &lt;&lt; <span class="number">32</span>);</span><br><span class="line">      <span class="keyword">int</span> bits = lowZeros(value);</span><br><span class="line">      <span class="keyword">if</span> (bits &gt; <span class="keyword">this</span>.maxbits) &#123;</span><br><span class="line">        <span class="keyword">this</span>.maxbits = bits;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">lowZeros</span><span class="params">(<span class="keyword">long</span> value)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">int</span> i = <span class="number">1</span>;</span><br><span class="line">      <span class="keyword">for</span> (; i &lt; <span class="number">32</span>; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (value &gt;&gt; i &lt;&lt; i != value) &#123;</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> i - <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Experiment</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> n;</span><br><span class="line">    <span class="keyword">private</span> BitKeeper keeper;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Experiment</span><span class="params">(<span class="keyword">int</span> n)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">this</span>.n = n;</span><br><span class="line">      <span class="keyword">this</span>.keeper = <span class="keyword">new</span> BitKeeper();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">work</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++) &#123;</span><br><span class="line">        <span class="keyword">this</span>.keeper.random();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">debug</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      System.out.printf(<span class="string">"%d %.2f %d\n"</span>, <span class="keyword">this</span>.n, Math.log(<span class="keyword">this</span>.n) / Math.log(<span class="number">2</span>), <span class="keyword">this</span>.keeper.maxbits);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1000</span>; i &lt; <span class="number">100000</span>; i += <span class="number">100</span>) &#123;</span><br><span class="line">      Experiment exp = <span class="keyword">new</span> Experiment(i);</span><br><span class="line">      exp.work();</span><br><span class="line">      exp.debug();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿è¡Œè§‚å¯Ÿè¾“å‡ºï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">36400 15.15 13</span><br><span class="line">36500 15.16 16</span><br><span class="line">36600 15.16 13</span><br><span class="line">36700 15.16 14</span><br><span class="line">36800 15.17 15</span><br><span class="line">36900 15.17 18</span><br><span class="line">37000 15.18 16</span><br><span class="line">37100 15.18 15</span><br><span class="line">37200 15.18 13</span><br><span class="line">37300 15.19 14</span><br><span class="line">37400 15.19 16</span><br><span class="line">37500 15.19 14</span><br><span class="line">37600 15.20 15</span><br></pre></td></tr></table></figure>
<p>é€šè¿‡è¿™å®éªŒå¯ä»¥å‘ç° K å’Œ N çš„å¯¹æ•°ä¹‹é—´å­˜åœ¨æ˜¾è‘—çš„çº¿æ€§ç›¸å…³æ€§ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">N=2^K  <span class="comment"># çº¦ç­‰äº</span></span><br></pre></td></tr></table></figure>
<p>å¦‚æœ N ä»‹äº 2^K å’Œ 2^(K+1) ä¹‹é—´ï¼Œç”¨è¿™ç§æ–¹å¼ä¼°è®¡çš„å€¼éƒ½ç­‰äº 2^Kï¼Œè¿™æ˜æ˜¾æ˜¯ä¸åˆç†çš„ã€‚è¿™é‡Œå¯ä»¥é‡‡ç”¨å¤šä¸ª BitKeeperï¼Œç„¶åè¿›è¡ŒåŠ æƒä¼°è®¡ï¼Œå°±å¯ä»¥å¾—åˆ°ä¸€ä¸ªæ¯”è¾ƒå‡†ç¡®çš„å€¼ã€‚</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> math</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">low_zeros</span><span class="params">(value)</span>:</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> xrange(<span class="number">1</span>, <span class="number">32</span>):</span><br><span class="line">        <span class="keyword">if</span> value &gt;&gt; i &lt;&lt; i != value:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">return</span> i - <span class="number">1</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BitKeeper</span><span class="params">(object)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.maxbits = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">random</span><span class="params">(self, m)</span>:</span></span><br><span class="line">        bits = low_zeros(m)</span><br><span class="line">        <span class="keyword">if</span> bits &gt; self.maxbits:</span><br><span class="line">            self.maxbits = bits</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Experiment</span><span class="params">(object)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, n, k=<span class="number">1024</span>)</span>:</span></span><br><span class="line">        self.n = n</span><br><span class="line">        self.k = k</span><br><span class="line">        self.keepers = [BitKeeper() <span class="keyword">for</span> i <span class="keyword">in</span> range(k)]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">do</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(self.n):</span><br><span class="line">            m = random.randint(<span class="number">0</span>, <span class="number">1</span>&lt;&lt;<span class="number">32</span><span class="number">-1</span>)</span><br><span class="line">            <span class="comment"># ç¡®ä¿åŒä¸€ä¸ªæ•´æ•°è¢«åˆ†é…åˆ°åŒä¸€ä¸ªæ¡¶é‡Œé¢ï¼Œæ‘˜å–é«˜ä½åå–æ¨¡</span></span><br><span class="line">            keeper = self.keepers[((m &amp; <span class="number">0xfff0000</span>) &gt;&gt; <span class="number">16</span>) % len(self.keepers)]</span><br><span class="line">            keeper.random(m)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">estimate</span><span class="params">(self)</span>:</span></span><br><span class="line">        sumbits_inverse = <span class="number">0</span>  <span class="comment"># é›¶ä½æ•°å€’æ•°</span></span><br><span class="line">        <span class="keyword">for</span> keeper <span class="keyword">in</span> self.keepers:</span><br><span class="line">            sumbits_inverse += <span class="number">1.0</span>/float(keeper.maxbits)</span><br><span class="line">        avgbits = float(self.k)/sumbits_inverse  <span class="comment"># å¹³å‡é›¶ä½æ•°</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">2</span>**avgbits * self.k  <span class="comment"># æ ¹æ®æ¡¶çš„æ•°é‡å¯¹ä¼°è®¡å€¼è¿›è¡Œæ”¾å¤§</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">100000</span>, <span class="number">1000000</span>, <span class="number">100000</span>):</span><br><span class="line">    exp = Experiment(i)</span><br><span class="line">    exp.do()</span><br><span class="line">    est = exp.estimate()</span><br><span class="line">    <span class="keyword">print</span> i, <span class="string">'%.2f'</span> % est, <span class="string">'%.2f'</span> % (abs(est-i) / i)</span><br></pre></td></tr></table></figure>
<p>ä¸‹é¢æ˜¯ Java ç‰ˆï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PfTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">BitKeeper</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> maxbits;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">random</span><span class="params">(<span class="keyword">long</span> value)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">int</span> bits = lowZeros(value);</span><br><span class="line">      <span class="keyword">if</span> (bits &gt; <span class="keyword">this</span>.maxbits) &#123;</span><br><span class="line">        <span class="keyword">this</span>.maxbits = bits;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">lowZeros</span><span class="params">(<span class="keyword">long</span> value)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">int</span> i = <span class="number">1</span>;</span><br><span class="line">      <span class="keyword">for</span> (; i &lt; <span class="number">32</span>; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (value &gt;&gt; i &lt;&lt; i != value) &#123;</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> i - <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Experiment</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> n;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> k;</span><br><span class="line">    <span class="keyword">private</span> BitKeeper[] keepers;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Experiment</span><span class="params">(<span class="keyword">int</span> n)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">this</span>(n, <span class="number">1024</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Experiment</span><span class="params">(<span class="keyword">int</span> n, <span class="keyword">int</span> k)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">this</span>.n = n;</span><br><span class="line">      <span class="keyword">this</span>.k = k;</span><br><span class="line">      <span class="keyword">this</span>.keepers = <span class="keyword">new</span> BitKeeper[k];</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; k; i++) &#123;</span><br><span class="line">        <span class="keyword">this</span>.keepers[i] = <span class="keyword">new</span> BitKeeper();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">work</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="keyword">this</span>.n; i++) &#123;</span><br><span class="line">        <span class="keyword">long</span> m = ThreadLocalRandom.current().nextLong(<span class="number">1L</span> &lt;&lt; <span class="number">32</span>);</span><br><span class="line">        BitKeeper keeper = keepers[(<span class="keyword">int</span>) (((m &amp; <span class="number">0xfff0000</span>) &gt;&gt; <span class="number">16</span>) % keepers.length)];</span><br><span class="line">        keeper.random(m);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">double</span> <span class="title">estimate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">double</span> sumbitsInverse = <span class="number">0.0</span>;</span><br><span class="line">      <span class="keyword">for</span> (BitKeeper keeper : keepers) &#123;</span><br><span class="line">        sumbitsInverse += <span class="number">1.0</span> / (<span class="keyword">float</span>) keeper.maxbits;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">double</span> avgBits = (<span class="keyword">float</span>) keepers.length / sumbitsInverse;</span><br><span class="line">      <span class="keyword">return</span> Math.pow(<span class="number">2</span>, avgBits) * <span class="keyword">this</span>.k;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">100000</span>; i &lt; <span class="number">1000000</span>; i += <span class="number">100000</span>) &#123;</span><br><span class="line">      Experiment exp = <span class="keyword">new</span> Experiment(i);</span><br><span class="line">      exp.work();</span><br><span class="line">      <span class="keyword">double</span> est = exp.estimate();</span><br><span class="line">      System.out.printf(<span class="string">"%d %.2f %.2f\n"</span>, i, est, Math.abs(est - i) / i);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä»£ç ä¸­åˆ†äº† 1024 ä¸ªæ¡¶ï¼Œè®¡ç®—å¹³å‡æ•°ä½¿ç”¨äº†è°ƒå’Œå¹³å‡ (å€’æ•°çš„å¹³å‡)ã€‚æ™®é€šçš„å¹³å‡æ³•å¯èƒ½å› ä¸ºä¸ªåˆ«ç¦»ç¾¤å€¼å¯¹å¹³å‡ç»“æœäº§ç”Ÿè¾ƒå¤§çš„å½±å“ï¼Œè°ƒå’Œå¹³å‡å¯ä»¥æœ‰æ•ˆå¹³æ»‘ç¦»ç¾¤å€¼çš„å½±å“ã€‚</p>
<p><img src="https://user-gold-cdn.xitu.io/2018/7/12/1648f0fa8841ceb1?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" alt="img"></p>
<p>è§‚å¯Ÿè„šæœ¬çš„è¾“å‡ºï¼Œè¯¯å·®ç‡æ§åˆ¶åœ¨ç™¾åˆ†æ¯”ä¸ªä½æ•°ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">100000 97287.38 0.03</span><br><span class="line">200000 189369.02 0.05</span><br><span class="line">300000 287770.04 0.04</span><br><span class="line">400000 401233.52 0.00</span><br><span class="line">500000 491704.97 0.02</span><br><span class="line">600000 604233.92 0.01</span><br><span class="line">700000 721127.67 0.03</span><br><span class="line">800000 832308.12 0.04</span><br><span class="line">900000 870954.86 0.03</span><br><span class="line">1000000 1075497.64 0.08</span><br></pre></td></tr></table></figure>
<p>&nbsp;</p>
<p>çœŸå®çš„ HyperLogLog è¦æ¯”ä¸Šé¢çš„ç¤ºä¾‹ä»£ç æ›´åŠ å¤æ‚ä¸€äº›ï¼Œä¹Ÿæ›´åŠ ç²¾ç¡®ä¸€äº›ã€‚ä¸Šé¢çš„è¿™ä¸ªç®—æ³•åœ¨éšæœºæ¬¡æ•°å¾ˆå°‘çš„æƒ…å†µä¸‹ä¼šå‡ºç°é™¤é›¶é”™è¯¯ï¼Œå› ä¸º maxbits=0 æ˜¯ä¸å¯ä»¥æ±‚å€’æ•°çš„ã€‚</p>
<p>&nbsp;</p>
<h3 id="pf-çš„å†…å­˜å ç”¨ä¸ºä»€ä¹ˆæ˜¯-12kï¼Ÿ"><a href="#pf-çš„å†…å­˜å ç”¨ä¸ºä»€ä¹ˆæ˜¯-12kï¼Ÿ" class="headerlink" title="pf çš„å†…å­˜å ç”¨ä¸ºä»€ä¹ˆæ˜¯ 12kï¼Ÿ"></a>pf çš„å†…å­˜å ç”¨ä¸ºä»€ä¹ˆæ˜¯ 12kï¼Ÿ</h3><p>æˆ‘ä»¬åœ¨ä¸Šé¢çš„ç®—æ³•ä¸­ä½¿ç”¨äº† 1024 ä¸ªæ¡¶è¿›è¡Œç‹¬ç«‹è®¡æ•°ï¼Œä¸è¿‡åœ¨ Redis çš„ HyperLogLog å®ç°ä¸­ç”¨åˆ°çš„æ˜¯ 16384 ä¸ªæ¡¶ï¼Œä¹Ÿå°±æ˜¯ 2^14ï¼Œæ¯ä¸ªæ¡¶çš„ maxbits éœ€è¦ 6 ä¸ª bits æ¥å­˜å‚¨ï¼Œæœ€å¤§å¯ä»¥è¡¨ç¤º maxbits=63ï¼Œäºæ˜¯æ€»å…±å ç”¨å†…å­˜å°±æ˜¯<code>2^14 * 6 / 8 = 12k</code>å­—èŠ‚ã€‚</p>
<p>&nbsp;</p>
<h3 id="æ€è€ƒ-amp-ä½œä¸š"><a href="#æ€è€ƒ-amp-ä½œä¸š" class="headerlink" title="æ€è€ƒ &amp; ä½œä¸š"></a>æ€è€ƒ &amp; ä½œä¸š</h3><p>å°è¯•å°†ä¸€å †æ•°æ®è¿›è¡Œåˆ†ç»„ï¼Œåˆ†åˆ«è¿›è¡Œè®¡æ•°ï¼Œå†ä½¿ç”¨ pfmerge åˆå¹¶åˆ°ä¸€èµ·ï¼Œè§‚å¯Ÿ pfcount è®¡æ•°å€¼ï¼Œä¸ä¸åˆ†ç»„çš„æƒ…å†µä¸‹çš„ç»Ÿè®¡ç»“æœè¿›è¡Œæ¯”è¾ƒï¼Œè§‚å¯Ÿæœ‰æ²¡æœ‰å·®å¼‚ã€‚</p>
<p>&nbsp;</p>
<h2 id="æ‰©å±•é˜…è¯»"><a href="#æ‰©å±•é˜…è¯»" class="headerlink" title="æ‰©å±•é˜…è¯»"></a>æ‰©å±•é˜…è¯»</h2><ul>
<li>HyperLogLog å¤æ‚çš„å…¬å¼æ¨å¯¼è¯·é˜…è¯» <a href="https://link.juejin.im/?target=https%3A%2F%2Fwww.slideshare.net%2FKaiZhang130%2Fcountdistinct-problem-88329470" target="_blank" rel="noopener">Count-Distinct Problem</a>ï¼Œå¦‚æœä½ çš„æ¦‚ç‡è®ºåŸºç¡€ä¸å¥½ï¼Œé‚£å°±å»ºè®®ä¸è¦çœ‹äº†ï¼ˆå¦ï¼Œè¿™ä¸ª PPT éœ€è¦ç¿»å¢™è§‚çœ‹ï¼‰ã€‚</li>
</ul>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">æ–‡ç« ä½œè€…: </span><span class="post-copyright-info"><a href="mailto:undefined">CAI TB</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">æ–‡ç« é“¾æ¥: </span><span class="post-copyright-info"><a href="https://caitb.github.io/2018/09/25/Redis æ·±åº¦å†é™©/6åº”ç”¨ 4ï¼šå››ä¸¤æ‹¨åƒæ–¤ â€”â€” HyperLogLog/">https://caitb.github.io/2018/09/25/Redis æ·±åº¦å†é™©/6åº”ç”¨ 4ï¼šå››ä¸¤æ‹¨åƒæ–¤ â€”â€” HyperLogLog/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">ç‰ˆæƒå£°æ˜: </span><span class="post-copyright-info">æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> è®¸å¯åè®®ã€‚è½¬è½½è¯·æ³¨æ˜æ¥è‡ª <a href="https://caitb.github.io" target="_blank">CAITBã®Blog</a>ï¼</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/è½¬å‘/">è½¬å‘</a><a class="post-meta__tags" href="/tags/Redis/">Redis</a></div><nav id="pagination"><div class="prev-post pull-left"><a href="/2018/09/25/Redis æ·±åº¦å†é™©/7åº”ç”¨ 5ï¼šå±‚å³¦å å¶‚ â€”â€” å¸ƒéš†è¿‡æ»¤å™¨/"><i class="fa fa-chevron-left">  </i><span>åº”ç”¨ 5ï¼šå±‚å³¦å å¶‚ â€”â€” å¸ƒéš†è¿‡æ»¤å™¨</span></a></div><div class="next-post pull-right"><a href="/2018/09/25/Redis æ·±åº¦å†é™©/5åº”ç”¨ 3ï¼šèŠ‚è¡£ç¼©é£Ÿ â€”â€” ä½å›¾/"><span>åº”ç”¨ 2ï¼šåº”ç”¨ 3ï¼šèŠ‚è¡£ç¼©é£Ÿ â€”â€” ä½å›¾</span><i class="fa fa-chevron-right"></i></a></div></nav></div></div><footer><div class="layout" id="footer"><div class="copyright">&copy;2013 - 2018 By CAI TB</div><div class="framework-info"><span>é©±åŠ¨ - </span><a href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>ä¸»é¢˜ - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="busuanzi"><script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file-o"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="/js/third-party/anime.min.js"></script><script src="/js/third-party/jquery.min.js"></script><script src="/js/third-party/jquery.easing.1.3.js"></script><script src="/js/third-party/jquery.fancybox.min.js"></script><script src="/js/third-party/velocity.min.js"></script><script src="/js/third-party/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.5.6"></script><script src="/js/fancybox.js?version=1.5.6"></script><script src="/js/sidebar.js?version=1.5.6"></script><script src="/js/copy.js?version=1.5.6"></script><script src="/js/fireworks.js?version=1.5.6"></script><script src="/js/transition.js?version=1.5.6"></script><script src="/js/scroll.js?version=1.5.6"></script><script src="/js/head.js?version=1.5.6"></script><script src="/js/search/local-search.js"></script><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">æœ¬åœ°æœç´¢</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="æœç´¢æ–‡ç« "></div></div></div><hr><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>ç”±</span> <a href="https://github.com/wzpan/hexo-generator-search" style="color:#49B1F5;">hexo-generator-search</a>
 <span>æä¾›æ”¯æŒ</span></div></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div></body></html>