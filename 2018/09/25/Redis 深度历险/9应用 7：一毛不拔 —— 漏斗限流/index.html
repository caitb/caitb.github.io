<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="åº”ç”¨ 7ï¼šä¸€æ¯›ä¸æ‹” â€”â€” æ¼æ–—é™æµ"><meta name="keywords" content="è½¬å‘,Redis"><meta name="author" content="CAI TB,undefined"><meta name="copyright" content="CAI TB"><title>åº”ç”¨ 7ï¼šä¸€æ¯›ä¸æ‹” â€”â€” æ¼æ–—é™æµ | CAITBã®Blog</title><link rel="shortcut icon" href="/my-favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.5.6"><link rel="stylesheet" href="/css/vue.css?version=1.5.6"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css?version=1.5.6"><link rel="dns-prefetch" href="https://cdn.staticfile.org"><link rel="dns-prefetch" href="https://cdn.bootcss.com"><link rel="dns-prefetch" href="https://creativecommons.org"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"æ‰¾ä¸åˆ°æ‚¨æŸ¥è¯¢çš„å†…å®¹:${query}"}},
  copy: {
    success: 'å¤åˆ¶æˆåŠŸ',
    error: 'å¤åˆ¶é”™è¯¯',
    noSupport: 'æµè§ˆå™¨ä¸æ”¯æŒ'
  }
} </script></head><body><canvas class="fireworks"></canvas><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div class="sidebar" id="sidebar"><div class="toggle-sidebar-info text-center"><span data-toggle="åˆ‡æ¢æ–‡ç« è¯¦æƒ…">åˆ‡æ¢ç«™ç‚¹æ¦‚è§ˆ</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">ç›®å½•</div><div class="sidebar-toc__progress"><span class="progress-notice">ä½ å·²ç»è¯»äº†</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-nav sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#Redis-Cell"><span class="toc-number">1.</span> <span class="toc-text">Redis-Cell</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#æ€è€ƒ"><span class="toc-number">2.</span> <span class="toc-text">æ€è€ƒ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#æ‹“å±•é˜…è¯»"><span class="toc-number">3.</span> <span class="toc-text">æ‹“å±•é˜…è¯»</span></a></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="https://ws2.sinaimg.cn/large/006tNbRwgy1fvak7x33btj30500500ui.jpg"></div><div class="author-info__name text-center">CAI TB</div><div class="author-info__description text-center"></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">æ–‡ç« </span><span class="pull-right">27</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">æ ‡ç­¾</span><span class="pull-right">11</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">åˆ†ç±»</span><span class="pull-right">2</span></a></div></div></div><div class="content" id="content-outer"><div id="top-container" style="background-image: url(https://ws1.sinaimg.cn/large/006tNbRwgy1fvak4ulv7nj31hc0xc0yl.jpg)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">CAITBã®Blog</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus"><a class="site-page social-icon search"><i class="fa fa-search"></i><span> æœç´¢</span></a><a class="site-page" href="/">é¦–é¡µ</a><a class="site-page" href="/archives">å½’æ¡£</a><a class="site-page" href="/tags">æ ‡ç­¾</a><a class="site-page" href="/categories">åˆ†ç±»</a></span></div><div id="post-info"><div id="post-title">åº”ç”¨ 7ï¼šä¸€æ¯›ä¸æ‹” â€”â€” æ¼æ–—é™æµ</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2018-09-25</time></div></div></div><div class="layout" id="content-inner"><article class="markdown-section" id="post"><div class="article-container" id="post-content"><blockquote>
<p><span style="color:rgb(61, 170, 214)">ä½œè€…ï¼š</span>æ˜é‡‘å°å†Œ</p>
<p><span style="color:rgb(61, 170, 214)">æ¥æºï¼š</span><a href="https://juejin.im/books" target="_blank" rel="noopener">https://juejin.im/books</a></p>
</blockquote>
<p>æ¼æ–—é™æµæ˜¯æœ€å¸¸ç”¨çš„é™æµæ–¹æ³•ä¹‹ä¸€ï¼Œé¡¾åæ€ä¹‰ï¼Œè¿™ä¸ªç®—æ³•çš„çµæ„Ÿæºäºæ¼æ–—ï¼ˆfunnelï¼‰çš„ç»“æ„ã€‚</p>
<p><img src="https://user-gold-cdn.xitu.io/2018/7/10/164847a37cfcea2e?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" alt="img"></p>
<p>æ¼æ–—çš„å®¹é‡æ˜¯æœ‰é™çš„ï¼Œå¦‚æœå°†æ¼å˜´å µä½ï¼Œç„¶åä¸€ç›´å¾€é‡Œé¢çŒæ°´ï¼Œå®ƒå°±ä¼šå˜æ»¡ï¼Œç›´è‡³å†ä¹Ÿè£…ä¸è¿›å»ã€‚å¦‚æœå°†æ¼å˜´æ”¾å¼€ï¼Œæ°´å°±ä¼šå¾€ä¸‹æµï¼Œæµèµ°ä¸€éƒ¨åˆ†ä¹‹åï¼Œå°±åˆå¯ä»¥ç»§ç»­å¾€é‡Œé¢çŒæ°´ã€‚å¦‚æœæ¼å˜´æµæ°´çš„é€Ÿç‡å¤§äºçŒæ°´çš„é€Ÿç‡ï¼Œé‚£ä¹ˆæ¼æ–—æ°¸è¿œéƒ½è£…ä¸æ»¡ã€‚å¦‚æœæ¼å˜´æµæ°´é€Ÿç‡å°äºçŒæ°´çš„é€Ÿç‡ï¼Œé‚£ä¹ˆä¸€æ—¦æ¼æ–—æ»¡äº†ï¼ŒçŒæ°´å°±éœ€è¦æš‚åœå¹¶ç­‰å¾…æ¼æ–—è…¾ç©ºã€‚</p>
<p><img src="https://user-gold-cdn.xitu.io/2018/7/11/16487813367a459d?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" alt="img"></p>
<p>æ‰€ä»¥ï¼Œæ¼æ–—çš„å‰©ä½™ç©ºé—´å°±ä»£è¡¨ç€å½“å‰è¡Œä¸ºå¯ä»¥æŒç»­è¿›è¡Œçš„æ•°é‡ï¼Œæ¼å˜´çš„æµæ°´é€Ÿç‡ä»£è¡¨ç€ç³»ç»Ÿå…è®¸è¯¥è¡Œä¸ºçš„æœ€å¤§é¢‘ç‡ã€‚ä¸‹é¢æˆ‘ä»¬ä½¿ç”¨ä»£ç æ¥æè¿°å•æœºæ¼æ–—ç®—æ³•ã€‚</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># coding: utf8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Funnel</span><span class="params">(object)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, capacity, leaking_rate)</span>:</span></span><br><span class="line">        self.capacity = capacity  <span class="comment"># æ¼æ–—å®¹é‡</span></span><br><span class="line">        self.leaking_rate = leaking_rate  <span class="comment"># æ¼å˜´æµæ°´é€Ÿç‡</span></span><br><span class="line">        self.left_quota = capacity  <span class="comment"># æ¼æ–—å‰©ä½™ç©ºé—´</span></span><br><span class="line">        self.leaking_ts = time.time()  <span class="comment"># ä¸Šä¸€æ¬¡æ¼æ°´æ—¶é—´</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">make_space</span><span class="params">(self)</span>:</span></span><br><span class="line">        now_ts = time.time()</span><br><span class="line">        delta_ts = now_ts - self.leaking_ts  <span class="comment"># è·ç¦»ä¸Šä¸€æ¬¡æ¼æ°´è¿‡å»äº†å¤šä¹…</span></span><br><span class="line">        delta_quota = delta_ts * self.leaking_rate  <span class="comment"># åˆå¯ä»¥è…¾å‡ºä¸å°‘ç©ºé—´äº†</span></span><br><span class="line">        <span class="keyword">if</span> delta_quota &lt; <span class="number">1</span>:  <span class="comment"># è…¾çš„ç©ºé—´å¤ªå°‘ï¼Œé‚£å°±ç­‰ä¸‹æ¬¡å§</span></span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        self.left_quota += delta_quota  <span class="comment"># å¢åŠ å‰©ä½™ç©ºé—´</span></span><br><span class="line">        self.leaking_ts = now_ts  <span class="comment"># è®°å½•æ¼æ°´æ—¶é—´</span></span><br><span class="line">        <span class="keyword">if</span> self.left_quota &gt; self.capacity:  <span class="comment"># å‰©ä½™ç©ºé—´ä¸å¾—é«˜äºå®¹é‡</span></span><br><span class="line">            self.left_quota = self.capacity</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">watering</span><span class="params">(self, quota)</span>:</span></span><br><span class="line">        self.make_space()</span><br><span class="line">        <span class="keyword">if</span> self.left_quota &gt;= quota:  <span class="comment"># åˆ¤æ–­å‰©ä½™ç©ºé—´æ˜¯å¦è¶³å¤Ÿ</span></span><br><span class="line">            self.left_quota -= quota</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">True</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">funnels = &#123;&#125;  <span class="comment"># æ‰€æœ‰çš„æ¼æ–—</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># capacity  æ¼æ–—å®¹é‡</span></span><br><span class="line"><span class="comment"># leaking_rate æ¼å˜´æµæ°´é€Ÿç‡ quota/s</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">is_action_allowed</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        user_id, action_key, capacity, leaking_rate)</span>:</span></span><br><span class="line">    key = <span class="string">'%s:%s'</span> % (user_id, action_key)</span><br><span class="line">    funnel = funnels.get(key)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> funnel:</span><br><span class="line">        funnel = Funnel(capacity, leaking_rate)</span><br><span class="line">        funnels[key] = funnel</span><br><span class="line">    <span class="keyword">return</span> funnel.watering(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">20</span>):</span><br><span class="line">    <span class="keyword">print</span> is_action_allowed(<span class="string">'laoqian'</span>, <span class="string">'reply'</span>, <span class="number">15</span>, <span class="number">0.5</span>)</span><br></pre></td></tr></table></figure>
<p>å†æä¾›ä¸€ä¸ª Java ç‰ˆæœ¬çš„ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FunnelRateLimiter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Funnel</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> capacity;</span><br><span class="line">    <span class="keyword">float</span> leakingRate;</span><br><span class="line">    <span class="keyword">int</span> leftQuota;</span><br><span class="line">    <span class="keyword">long</span> leakingTs;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Funnel</span><span class="params">(<span class="keyword">int</span> capacity, <span class="keyword">float</span> leakingRate)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">this</span>.capacity = capacity;</span><br><span class="line">      <span class="keyword">this</span>.leakingRate = leakingRate;</span><br><span class="line">      <span class="keyword">this</span>.leftQuota = capacity;</span><br><span class="line">      <span class="keyword">this</span>.leakingTs = System.currentTimeMillis();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">makeSpace</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">long</span> nowTs = System.currentTimeMillis();</span><br><span class="line">      <span class="keyword">long</span> deltaTs = nowTs - leakingTs;</span><br><span class="line">      <span class="keyword">int</span> deltaQuota = (<span class="keyword">int</span>) (deltaTs * leakingRate);</span><br><span class="line">      <span class="keyword">if</span> (deltaQuota &lt; <span class="number">0</span>) &#123; <span class="comment">// é—´éš”æ—¶é—´å¤ªé•¿ï¼Œæ•´æ•°æ•°å­—è¿‡å¤§æº¢å‡º</span></span><br><span class="line">        <span class="keyword">this</span>.leftQuota = capacity;</span><br><span class="line">        <span class="keyword">this</span>.leakingTs = nowTs;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (deltaQuota &lt; <span class="number">1</span>) &#123; <span class="comment">// è…¾å‡ºç©ºé—´å¤ªå°ï¼Œæœ€å°å•ä½æ˜¯1</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">this</span>.leftQuota += deltaQuota;</span><br><span class="line">      <span class="keyword">this</span>.leakingTs = nowTs;</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">this</span>.leftQuota &gt; <span class="keyword">this</span>.capacity) &#123;</span><br><span class="line">        <span class="keyword">this</span>.leftQuota = <span class="keyword">this</span>.capacity;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">boolean</span> <span class="title">watering</span><span class="params">(<span class="keyword">int</span> quota)</span> </span>&#123;</span><br><span class="line">      makeSpace();</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">this</span>.leftQuota &gt;= quota) &#123;</span><br><span class="line">        <span class="keyword">this</span>.leftQuota -= quota;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> Map&lt;String, Funnel&gt; funnels = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isActionAllowed</span><span class="params">(String userId, String actionKey, <span class="keyword">int</span> capacity, <span class="keyword">float</span> leakingRate)</span> </span>&#123;</span><br><span class="line">    String key = String.format(<span class="string">"%s:%s"</span>, userId, actionKey);</span><br><span class="line">    Funnel funnel = funnels.get(key);</span><br><span class="line">    <span class="keyword">if</span> (funnel == <span class="keyword">null</span>) &#123;</span><br><span class="line">      funnel = <span class="keyword">new</span> Funnel(capacity, leakingRate);</span><br><span class="line">      funnels.put(key, funnel);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> funnel.watering(<span class="number">1</span>); <span class="comment">// éœ€è¦1ä¸ªquota</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Funnel å¯¹è±¡çš„ make_space æ–¹æ³•æ˜¯æ¼æ–—ç®—æ³•çš„æ ¸å¿ƒï¼Œå…¶åœ¨æ¯æ¬¡çŒæ°´å‰éƒ½ä¼šè¢«è°ƒç”¨ä»¥è§¦å‘æ¼æ°´ï¼Œç»™æ¼æ–—è…¾å‡ºç©ºé—´æ¥ã€‚èƒ½è…¾å‡ºå¤šå°‘ç©ºé—´å–å†³äºè¿‡å»äº†å¤šä¹…ä»¥åŠæµæ°´çš„é€Ÿç‡ã€‚Funnel å¯¹è±¡å æ®çš„ç©ºé—´å¤§å°ä¸å†å’Œè¡Œä¸ºçš„é¢‘ç‡æˆæ­£æ¯”ï¼Œå®ƒçš„ç©ºé—´å ç”¨æ˜¯ä¸€ä¸ªå¸¸é‡ã€‚</p>
<p>é—®é¢˜æ¥äº†ï¼Œåˆ†å¸ƒå¼çš„æ¼æ–—ç®—æ³•è¯¥å¦‚ä½•å®ç°ï¼Ÿèƒ½ä¸èƒ½ä½¿ç”¨ Redis çš„åŸºç¡€æ•°æ®ç»“æ„æ¥æå®šï¼Ÿ</p>
<p>æˆ‘ä»¬è§‚å¯Ÿ Funnel å¯¹è±¡çš„å‡ ä¸ªå­—æ®µï¼Œæˆ‘ä»¬å‘ç°å¯ä»¥å°† Funnel å¯¹è±¡çš„å†…å®¹æŒ‰å­—æ®µå­˜å‚¨åˆ°ä¸€ä¸ª hash ç»“æ„ä¸­ï¼ŒçŒæ°´çš„æ—¶å€™å°† hash ç»“æ„çš„å­—æ®µå–å‡ºæ¥è¿›è¡Œé€»è¾‘è¿ç®—åï¼Œå†å°†æ–°å€¼å›å¡«åˆ° hash ç»“æ„ä¸­å°±å®Œæˆäº†ä¸€æ¬¡è¡Œä¸ºé¢‘åº¦çš„æ£€æµ‹ã€‚</p>
<p>ä½†æ˜¯æœ‰ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬æ— æ³•ä¿è¯æ•´ä¸ªè¿‡ç¨‹çš„åŸå­æ€§ã€‚ä» hash ç»“æ„ä¸­å–å€¼ï¼Œç„¶ååœ¨å†…å­˜é‡Œè¿ç®—ï¼Œå†å›å¡«åˆ° hash ç»“æ„ï¼Œè¿™ä¸‰ä¸ªè¿‡ç¨‹æ— æ³•åŸå­åŒ–ï¼Œæ„å‘³ç€éœ€è¦è¿›è¡Œé€‚å½“çš„åŠ é”æ§åˆ¶ã€‚è€Œä¸€æ—¦åŠ é”ï¼Œå°±æ„å‘³ç€ä¼šæœ‰åŠ é”å¤±è´¥ï¼ŒåŠ é”å¤±è´¥å°±éœ€è¦é€‰æ‹©é‡è¯•æˆ–è€…æ”¾å¼ƒã€‚</p>
<p>å¦‚æœé‡è¯•çš„è¯ï¼Œå°±ä¼šå¯¼è‡´æ€§èƒ½ä¸‹é™ã€‚å¦‚æœæ”¾å¼ƒçš„è¯ï¼Œå°±ä¼šå½±å“ç”¨æˆ·ä½“éªŒã€‚åŒæ—¶ï¼Œä»£ç çš„å¤æ‚åº¦ä¹Ÿè·Ÿç€å‡é«˜å¾ˆå¤šã€‚è¿™çœŸæ˜¯ä¸ªè‰°éš¾çš„é€‰æ‹©ï¼Œæˆ‘ä»¬è¯¥å¦‚ä½•è§£å†³è¿™ä¸ªé—®é¢˜å‘¢ï¼ŸRedis-Cell æ•‘æ˜Ÿæ¥äº†ï¼</p>
<p>&nbsp;</p>
<h3 id="Redis-Cell"><a href="#Redis-Cell" class="headerlink" title="Redis-Cell"></a>Redis-Cell</h3><p>Redis 4.0 æä¾›äº†ä¸€ä¸ªé™æµ Redis æ¨¡å—ï¼Œå®ƒå« redis-cellã€‚è¯¥æ¨¡å—ä¹Ÿä½¿ç”¨äº†æ¼æ–—ç®—æ³•ï¼Œå¹¶æä¾›äº†åŸå­çš„é™æµæŒ‡ä»¤ã€‚æœ‰äº†è¿™ä¸ªæ¨¡å—ï¼Œé™æµé—®é¢˜å°±éå¸¸ç®€å•äº†ã€‚</p>
<p><img src="https://user-gold-cdn.xitu.io/2018/7/11/1648780927d6f4ec?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" alt="img"></p>
<p>è¯¥æ¨¡å—åªæœ‰1æ¡æŒ‡ä»¤<code>cl.throttle</code>ï¼Œå®ƒçš„å‚æ•°å’Œè¿”å›å€¼éƒ½ç•¥æ˜¾å¤æ‚ï¼Œæ¥ä¸‹æ¥è®©æˆ‘ä»¬æ¥çœ‹çœ‹è¿™ä¸ªæŒ‡ä»¤å…·ä½“è¯¥å¦‚ä½•ä½¿ç”¨ã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&gt; cl.throttle laoqian:reply 15 30 60 1</span><br><span class="line">                      â–²     â–²  â–²  â–²  â–²</span><br><span class="line">                      |     |  |  |  â””â”€â”€â”€â”€â”€ need 1 quota (å¯é€‰å‚æ•°ï¼Œé»˜è®¤å€¼ä¹Ÿæ˜¯1)</span><br><span class="line">                      |     |  â””â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€ 30 operations / 60 seconds è¿™æ˜¯æ¼æ°´é€Ÿç‡</span><br><span class="line">                      |     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 15 capacity è¿™æ˜¯æ¼æ–—å®¹é‡</span><br><span class="line">                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ key laoqian</span><br></pre></td></tr></table></figure>
<p>ä¸Šé¢è¿™ä¸ªæŒ‡ä»¤çš„æ„æ€æ˜¯å…è®¸ã€Œç”¨æˆ·è€é’±å›å¤è¡Œä¸ºã€çš„é¢‘ç‡ä¸ºæ¯ 60s æœ€å¤š 30 æ¬¡(æ¼æ°´é€Ÿç‡)ï¼Œæ¼æ–—çš„åˆå§‹å®¹é‡ä¸º 15ï¼Œä¹Ÿå°±æ˜¯è¯´ä¸€å¼€å§‹å¯ä»¥è¿ç»­å›å¤ 15 ä¸ªå¸–å­ï¼Œç„¶åæ‰å¼€å§‹å—æ¼æ°´é€Ÿç‡çš„å½±å“ã€‚æˆ‘ä»¬çœ‹åˆ°è¿™ä¸ªæŒ‡ä»¤ä¸­æ¼æ°´é€Ÿç‡å˜æˆäº† 2 ä¸ªå‚æ•°ï¼Œæ›¿ä»£äº†ä¹‹å‰çš„å•ä¸ªæµ®ç‚¹æ•°ã€‚ç”¨ä¸¤ä¸ªå‚æ•°ç›¸é™¤çš„ç»“æœæ¥è¡¨è¾¾æ¼æ°´é€Ÿç‡ç›¸å¯¹å•ä¸ªæµ®ç‚¹æ•°è¦æ›´åŠ ç›´è§‚ä¸€äº›ã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&gt; cl.throttle laoqian:reply 15 30 60</span><br><span class="line">1) (<span class="built_in">integer</span>) 0   <span class="comment"># 0 è¡¨ç¤ºå…è®¸ï¼Œ1è¡¨ç¤ºæ‹’ç»</span></span><br><span class="line">2) (<span class="built_in">integer</span>) 15  <span class="comment"># æ¼æ–—å®¹é‡capacity</span></span><br><span class="line">3) (<span class="built_in">integer</span>) 14  <span class="comment"># æ¼æ–—å‰©ä½™ç©ºé—´left_quota</span></span><br><span class="line">4) (<span class="built_in">integer</span>) -1  <span class="comment"># å¦‚æœæ‹’ç»äº†ï¼Œéœ€è¦å¤šé•¿æ—¶é—´åå†è¯•(æ¼æ–—æœ‰ç©ºé—´äº†ï¼Œå•ä½ç§’)</span></span><br><span class="line">5) (<span class="built_in">integer</span>) 2   <span class="comment"># å¤šé•¿æ—¶é—´åï¼Œæ¼æ–—å®Œå…¨ç©ºå‡ºæ¥(left_quota==capacityï¼Œå•ä½ç§’)</span></span><br></pre></td></tr></table></figure>
<p>åœ¨æ‰§è¡Œé™æµæŒ‡ä»¤æ—¶ï¼Œå¦‚æœè¢«æ‹’ç»äº†ï¼Œå°±éœ€è¦ä¸¢å¼ƒæˆ–é‡è¯•ã€‚cl.throttle æŒ‡ä»¤è€ƒè™‘çš„éå¸¸å‘¨åˆ°ï¼Œè¿é‡è¯•æ—¶é—´éƒ½å¸®ä½ ç®—å¥½äº†ï¼Œç›´æ¥å–è¿”å›ç»“æœæ•°ç»„çš„ç¬¬å››ä¸ªå€¼è¿›è¡Œ sleep å³å¯ï¼Œå¦‚æœä¸æƒ³é˜»å¡çº¿ç¨‹ï¼Œä¹Ÿå¯ä»¥å¼‚æ­¥å®šæ—¶ä»»åŠ¡æ¥é‡è¯•ã€‚</p>
<p>&nbsp;</p>
<h3 id="æ€è€ƒ"><a href="#æ€è€ƒ" class="headerlink" title="æ€è€ƒ"></a>æ€è€ƒ</h3><p>æ¼æ–—é™æµæ¨¡å—é™¤äº†åº”ç”¨äº UGCï¼Œè¿˜èƒ½åº”ç”¨äºå“ªäº›åœ°æ–¹ï¼Ÿ</p>
<p>&nbsp;</p>
<h3 id="æ‹“å±•é˜…è¯»"><a href="#æ‹“å±•é˜…è¯»" class="headerlink" title="æ‹“å±•é˜…è¯»"></a>æ‹“å±•é˜…è¯»</h3><ol>
<li>ã€ŠRedis-Cell ä½œè€… Itamar Haber å…¶äººè¶£äº‹ã€‹</li>
</ol>
<p><img src="https://user-gold-cdn.xitu.io/2018/7/11/164872dc531f1a48?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" alt="img"></p>
<p>Redis-Cell ä½œè€… Itamar Haber çš„ä»‹ç»å¾ˆæœ‰æ„æ€â€”â€”ä¸€ä¸ªã€Œè‡ªå°ã€çš„ Redis æå®¢ã€‚è¿˜æœ‰ï¼ŒCell è¿™ä¸ªæ¨¡å—å±…ç„¶æ˜¯ç”¨ Rust ç¼–å†™çš„ã€‚â€”â€” åŸæ¥ Redis æ¨¡å—å¯ä»¥ä½¿ç”¨ Rust ç¼–å†™ï¼Ÿï¼</p>
<p>è¿™æ„å‘³ç€æˆ‘ä»¬ä¸ç”¨å»æå¤è€çš„ C è¯­è¨€äº†ã€‚è€é’±è¡¨ç¤ºè¦é‡æ–°æ‹¾èµ·æ”¾å¼ƒå¾ˆä¹…çš„ Rust è¯­è¨€ã€‚å“ï¼Œå¹²ç¨‹åºå‘˜è¿™ä¸€è¡Œï¼ŒçœŸæ˜¯è¦æ´»åˆ°è€ï¼Œå­¦åˆ°æ­»å•Šï¼ğŸ˜¢</p>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">æ–‡ç« ä½œè€…: </span><span class="post-copyright-info"><a href="mailto:undefined">CAI TB</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">æ–‡ç« é“¾æ¥: </span><span class="post-copyright-info"><a href="https://caitb.github.io/2018/09/25/Redis æ·±åº¦å†é™©/9åº”ç”¨ 7ï¼šä¸€æ¯›ä¸æ‹” â€”â€” æ¼æ–—é™æµ/">https://caitb.github.io/2018/09/25/Redis æ·±åº¦å†é™©/9åº”ç”¨ 7ï¼šä¸€æ¯›ä¸æ‹” â€”â€” æ¼æ–—é™æµ/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">ç‰ˆæƒå£°æ˜: </span><span class="post-copyright-info">æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> è®¸å¯åè®®ã€‚è½¬è½½è¯·æ³¨æ˜æ¥è‡ª <a href="https://caitb.github.io" target="_blank">CAITBã®Blog</a>ï¼</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/è½¬å‘/">è½¬å‘</a><a class="post-meta__tags" href="/tags/Redis/">Redis</a></div><nav id="pagination"><div class="next-post pull-right"><a href="/2018/09/25/Redis æ·±åº¦å†é™©/8åº”ç”¨ 6ï¼šæ–­å°¾æ±‚ç”Ÿ â€”â€” ç®€å•é™æµ/"><span>åº”ç”¨ 6ï¼šæ–­å°¾æ±‚ç”Ÿ â€”â€” ç®€å•é™æµ</span><i class="fa fa-chevron-right"></i></a></div></nav></div></div><footer><div class="layout" id="footer"><div class="copyright">&copy;2013 - 2018 By CAI TB</div><div class="framework-info"><span>é©±åŠ¨ - </span><a href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>ä¸»é¢˜ - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="busuanzi"><script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file-o"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="/js/third-party/anime.min.js"></script><script src="/js/third-party/jquery.min.js"></script><script src="/js/third-party/jquery.easing.1.3.js"></script><script src="/js/third-party/jquery.fancybox.min.js"></script><script src="/js/third-party/velocity.min.js"></script><script src="/js/third-party/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.5.6"></script><script src="/js/fancybox.js?version=1.5.6"></script><script src="/js/sidebar.js?version=1.5.6"></script><script src="/js/copy.js?version=1.5.6"></script><script src="/js/fireworks.js?version=1.5.6"></script><script src="/js/transition.js?version=1.5.6"></script><script src="/js/scroll.js?version=1.5.6"></script><script src="/js/head.js?version=1.5.6"></script><script src="/js/search/local-search.js"></script><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">æœ¬åœ°æœç´¢</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="æœç´¢æ–‡ç« "></div></div></div><hr><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>ç”±</span> <a href="https://github.com/wzpan/hexo-generator-search" style="color:#49B1F5;">hexo-generator-search</a>
 <span>æä¾›æ”¯æŒ</span></div></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div></body></html>